rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================
    // Helper functions
    // =====================================================
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isChatParticipant(chatId) {
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
    }
    
    function areValidFieldsToUpdate() {
        let allowedFields = ['name', 'avatarUrl', 'badgeOrder', 'hasCompletedOnboarding', 'chatIds', 'selectedVerifiedContacts', 'hasMadeVipSelection', 'lastSeen', 'allowedNormalContacts', 'blockedUsers', 'chatColorPreferences'];
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(allowedFields);
    }

    // =====================================================
    // Users Collection
    // =====================================================
    match /users/{userId} {
      // Allow any signed-in user to read public profile information.
      // This is necessary to display user names and avatars in the chat list.
      allow read: if isSignedIn();
      
      // Allow a user to create their own profile document.
      allow create: if isOwner(userId);
      
      // Allow a user to update their own profile, but only specific, non-sensitive fields.
      allow update: if isOwner(userId) && areValidFieldsToUpdate();
    }

    // =====================================================
    // Chats Collection
    // =====================================================
    match /chats/{chatId} {
      // Allow a user to GET a chat document if they are a participant.
      // This is used for loading individual chats.
      allow get: if isChatParticipant(chatId);
      
      // Allow a user to CREATE a chat if they are in the participants list of the new chat.
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participants;

      // Allow a participant to UPDATE a chat (e.g., for lastMessage).
      allow update: if isChatParticipant(chatId);

      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isChatParticipant(chatId);
        allow create: if isChatParticipant(chatId) && request.resource.data.senderId == request.auth.uid;
        allow update: if isChatParticipant(chatId)
                      && resource.data.senderId == request.auth.uid
                      && request.resource.data.isDeleted == true
                      && request.resource.data.diff(resource.data).affectedKeys().hasOnly([
                        'isDeleted', 'text', 'attachmentUrl', 'attachmentName', 'attachmentType', 'reactions', 'replyingTo'
                      ]);
      }
    }

    // =====================================================
    // Promo Codes
    // =====================================================
    match /vipPromoCodes/{code} { allow read: if isSignedIn(); allow write: if false; }
    match /pointsPromoCodes/{code} { allow read: if isSignedIn(); allow write: if false; }
    match /badgeGiftCodes/{code} { allow read: if isSignedIn(); allow write: if false; }

    // =====================================================
    // Deny everything else
    // =====================================================
    match /{document=**} { allow read, write: if false; }
  }
}
